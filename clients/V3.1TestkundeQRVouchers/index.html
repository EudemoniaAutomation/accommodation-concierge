<script>
(() => {
  // *** Production Webhook URL (n8n Webhook Trigger â†’ Production URL) ***
  const webhookUrl = "https://automation.eudemonia-coaching.de/webhook/477363f3-7434-4c31-92e5-fb4da3db4150";

  // DOM refs
  const inline = {
    messages: document.getElementById('inline-messages'),
    input: document.getElementById('inline-input'),
    send: document.getElementById('inline-send')
  };
  const popup = {
    wrap: document.getElementById('popup-wrap'),
    overlay: document.getElementById('popup-overlay'),
    messages: document.getElementById('popup-messages'),
    input: document.getElementById('popup-input'),
    send: document.getElementById('popup-send'),
    closeBtn: document.getElementById('popup-close')
  };
  const bubbleBtn = document.getElementById('bubble-btn');
  const bubbleBadge = document.getElementById('bubble-badge');
  const QR_IMG = document.getElementById('apt-qr-img');
  const QR_LINK = document.getElementById('apt-qr');

  // ----- Popup controls -----
  function openPopup() {
    popup.wrap.style.display = 'block';
    popup.overlay.style.display = 'block';
    bubbleBadge.style.display = 'none';
    setTimeout(() => popup.input?.focus(), 50);
  }
  function closePopup() {
    popup.wrap.style.display = 'none';
    popup.overlay.style.display = 'none';
  }
  function togglePopup() {
    const isOpen = popup.wrap.style.display === 'block';
    if (isOpen) closePopup(); else openPopup();
  }
  bubbleBtn.addEventListener('click', togglePopup);
  popup.closeBtn.addEventListener('click', closePopup);
  popup.overlay.addEventListener('click', closePopup);

  // ----- QR opens overlay only -----
  QR_LINK.addEventListener('click', (e) => { e.preventDefault(); openPopup(); });

  // ----- Generate QR (encodes ?openChat=1#openChat) -----
  (function setQr(){
    const base = location.href.split('#')[0];
    const url = new URL(base);
    url.searchParams.set('openChat', '1');
    const target = url.toString() + '#openChat';

    const src1 = 'https://quickchart.io/qr?text=' + encodeURIComponent(target) +
                 '&size=512&margin=8&ecLevel=H&format=png&dark=%23000000&light=%23ffffff00';
    const src2 = 'https://chart.googleapis.com/chart?cht=qr&chs=512x512&chld=H|1&chl=' + encodeURIComponent(target);

    const img = QR_IMG;
    img.onerror = function(){ if (img.dataset.fallback !== '1'){ img.dataset.fallback='1'; img.src = src2; } };
    img.src = src1;
  })();

  // ----- Auto-open via URL -----
  function tryOpenFromUrl(){
    const s = new URLSearchParams(location.search);
    if (location.hash === '#openChat' || s.get('openChat') === '1') openPopup();
  }
  window.addEventListener('hashchange', tryOpenFromUrl);
  tryOpenFromUrl();

  // ===== Helpers: pretty links + optional Redeem =====
  const urlRegex = /\b(https?:\/\/[^\s<>]+[^\s<\.)])/gi;

  function escapeHtml(s){
    return (s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function normalizeUrl(u){
    try{
      const x = new URL(u);
      x.hash = ''; // ignore hash for matching
      ['utm_source','utm_medium','utm_campaign','utm_term','utm_content','gclid','fbclid'].forEach(p=>x.searchParams.delete(p));
      let href = x.toString();
      if (href.endsWith('/')) href = href.slice(0,-1);
      return href;
    }catch{ return u; }
  }
  function shortenDisplay(u){
    try{
      const x = new URL(u);
      const parts = x.pathname.split('/').filter(Boolean);
      let tail = parts.slice(-2).join('/');
      if (tail.length > 24) tail = tail.slice(0,24)+'â€¦';
      return `${x.hostname}${tail ? '/'+tail : ''}`;
    }catch{ return u.length>28 ? u.slice(0,28)+'â€¦' : u; }
  }

  // NEW: Name+URL â†’ Name wird anklickbar, URL wird nicht separat gezeigt
  // Erfasst Varianten: "Trattoria Nera (https://â€¦)", "Trattoria Nera - https://â€¦", "Trattoria Nera: https://â€¦"
  function nameLinkify(text, voucherSet){
    let safe = escapeHtml(text || '');
    const replacedSet = new Set(); // normalisierte URLs, die bereits in Name-Ankern stecken

    const patterns = [
      // Name (URL)
      /([A-ZÃ„Ã–Ãœ][\wÃ€-Å¾&'â€™.\- ]{1,60})\s*(?:\(|ï¼ˆ)\s*(https?:\/\/[^\s<>]+[^\s<\.)])\s*(?:\)|ï¼‰)/g,
      // Name - URL  /  Name: URL  /  Name â€“ URL / Name â€” URL
      /([A-ZÃ„Ã–Ãœ][\wÃ€-Å¾&'â€™.\- ]{1,60})\s*(?:[â€“â€”-]|:)\s*(https?:\/\/[^\s<>]+[^\s<\.)])/g
    ];

    function makeNameAnchor(name, hrefRaw){
      const hrefNorm = normalizeUrl(hrefRaw);
      replacedSet.add(hrefNorm);
      const anchor = `<a href="${hrefRaw}" target="_blank" rel="noopener noreferrer">${escapeHtml(name.trim())}</a>`;
      const redeem = (voucherSet && voucherSet.has(hrefNorm))
        ? ` <a href="#" class="redeem" data-redeem="${encodeURIComponent(hrefRaw)}">Redeem Voucher</a>`
        : '';
      return `${anchor}${redeem}`;
    }

    // 1) Ersetze Name+URL Muster zuerst
    patterns.forEach(re => {
      safe = safe.replace(re, (_m, name, url) => makeNameAnchor(name, url));
    });

    // 2) Verbleibende rohe URLs (falls noch vorhanden) â†’ pretty Anchor (Fallback)
    safe = safe.replace(urlRegex, (match) => {
      const hrefRaw = match.replace(/&amp;/g,'&');
      const hrefNorm = normalizeUrl(hrefRaw);
      if (replacedSet.has(hrefNorm)) return ''; // schon als Name-Link verarbeitet
      const label = shortenDisplay(hrefRaw);
      const anchor = `<a href="${hrefRaw}" target="_blank" rel="noopener noreferrer">${label}</a>`;
      const redeem = (voucherSet && voucherSet.has(hrefNorm))
        ? ` <a href="#" class="redeem" data-redeem="${encodeURIComponent(hrefRaw)}">Redeem Voucher</a>`
        : '';
      return `${anchor}${redeem}`;
    });

    return safe;
  }

  function el(tag, cls){ const e=document.createElement(tag); if(cls)e.className=cls; return e; }
  function appendMsgHtml(target, html, sender){
    const m = el('div', 'msg ' + sender);
    m.innerHTML = html;
    target.appendChild(m);
    target.scrollTop = target.scrollHeight;
  }
  function appendMsgText(target, text, sender){
    const m = el('div', 'msg ' + sender);
    m.textContent = text;
    target.appendChild(m);
    target.scrollTop = target.scrollHeight;
  }
  function addBotAll(text, voucherSet){
    const html = nameLinkify(text, voucherSet); // <-- HIER: neue Logik
    appendMsgHtml(inline.messages, html, 'bot');
    appendMsgHtml(popup.messages, html, 'bot');
    if (popup.wrap.style.display!=='block'){ bubbleBadge.style.display='block'; bubbleBadge.textContent='1'; }
  }
  function addUserAll(text){
    appendMsgText(inline.messages, text, 'user');
    appendMsgText(popup.messages, text, 'user');
  }

  // Seed welcome
  addBotAll("Welcome! ðŸ‘‹ I'm here to help with check-in, house rules, and local recommendations. Just ask away!");

  // ===== Redeem handler (delegation) =====
  function onRedeem(linkHref, source){
    fetch(webhookUrl, {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
      body: JSON.stringify({ action:'redeem_voucher', link:linkHref, url:window.location.href, meta:{ source } })
    }).catch(()=>{});
  }
  function delegateRedeem(container, source){
    container.addEventListener('click', (e)=>{
      const a = e.target.closest('a.redeem');
      if(!a) return;
      e.preventDefault();
      const href = decodeURIComponent(a.getAttribute('data-redeem') || '');
      if(!href) return;
      onRedeem(href, source);
      a.textContent = 'Redeemed âœ“';
      a.style.pointerEvents = 'none';
      a.style.opacity = '0.7';
    });
  }
  delegateRedeem(inline.messages, 'inline');
  delegateRedeem(popup.messages, 'popup');

  // ===== Send handler (reads optional JSON with voucher flags) =====
  async function sendMessage(from){
    const input = from==='popup' ? popup.input : inline.input;
    const text = (input.value || '').trim();
    if(!text) return;
    addUserAll(text);
    input.value = '';

    try{
      const res = await fetch(webhookUrl, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Accept':'application/json, text/plain; q=0.9, */*; q=0.8' },
        body: JSON.stringify({ question:text, url:window.location.href, meta:{ source:from } })
      });

      const ct = (res.headers.get('content-type')||'').toLowerCase();
      let answer = '';
      let voucherSet = null;

      if (ct.includes('application/json')) {
        try {
          const data = await res.json();
          answer = (data?.answer || data?.text || data?.message || data?.content || '') + '';
          if (Array.isArray(data?.links)) {
            voucherSet = new Set(
              data.links
                .filter(l => l && l.url && l.voucher === true)
                .map(l => normalizeUrl(l.url))
            );
          }
        } catch {}
      }
      if (!answer) { try { answer = await res.text(); } catch {} }

      addBotAll(answer || 'No response received.', voucherSet);
    }catch(e){
      addBotAll('Error sending message.');
    }
  }

  document.getElementById('inline-send').addEventListener('click', ()=>sendMessage('inline'));
  document.getElementById('popup-send').addEventListener('click', ()=>sendMessage('popup'));
  document.getElementById('inline-input').addEventListener('keypress', e=>{ if(e.key==='Enter') sendMessage('inline'); });
  document.getElementById('popup-input').addEventListener('keypress', e=>{ if(e.key==='Enter') sendMessage('popup'); });
})();
</script>
