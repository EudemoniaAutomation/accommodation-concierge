<!-- ===== Accommodation-Concierge: Chat + QR (bubble brighter + QR opens popup) ===== -->
<div class="apt-landing"
     style="
       --bg:#121212; --ink:#e9f1ee; --muted:#aab7b1; --acc:#bff2da; --card:#171717; --ring:rgba(191,242,218,.25);
       /* Transparenz & Effekte */
       --chat_msg_alpha:.35; --wall2_dim:.35; --chat_glass_alpha:.30; --chat_blur:10px; --input_alpha:.35;
       /* QR-Plate & GrÃ¶ÃŸe */
       --qr_size:148px;
       --qr_plate_alpha:.72;
       --qr_blur:8px;
       --bubble_size:40px;
       /* Wallpaper hinter dem Chat */
       --wall2:url('https://d1yei2z3i6k35z.cloudfront.net/12820362/68a47346dc795_ModernCozyLivingRoom.jpeg?width=1920');
       font-family:Arial,system-ui; position:relative">
  <style>
    .apt-landing{color:var(--ink);background:linear-gradient(180deg,rgba(191,242,218,.10),rgba(191,242,218,.00));border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:24px}
    .apt-grid{display:grid;gap:22px;align-items:start}
    @media(min-width:880px){.apt-grid{grid-template-columns:1.05fr .95fr}}
    .apt-card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:22px}

    .apt-h1{margin:0 0 14px;text-align:center;line-height:1.15}
    .apt-h1 .prefix,.apt-h1 .main{display:block;font-weight:800;color:var(--ink);font-size:clamp(1.1rem,2.2vw,1.7rem)}
    .apt-h1 .main{white-space:nowrap}
    @media(max-width:420px){ .apt-h1 .prefix,.apt-h1 .main{font-size:1.05rem} }

    .apt-lead{margin:0 0 18px;color:var(--muted);text-align:center;font-weight:400}
    .apt-badges{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0 18px;justify-content:center}
    .apt-pill{display:inline-flex;align-items:center;gap:.4rem;border:1px solid var(--ring);border-radius:999px;padding:7px 12px;color:var(--acc);background:rgba(191,242,218,.10);font-weight:800;text-decoration:none;line-height:1}
    .apt-ul{margin:14px 0 0 0; list-style-position:inside; text-align:center}
    .apt-ul li{margin-bottom:10px}

    .apt-row{display:flex;justify-content:center}
    .apt-row-inner{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:center;margin-top:20px}
    .apt-cta{display:inline-flex;align-items:center;gap:.5rem;padding:8px 14px;border-radius:999px;background:var(--acc);color:#0e1f17;font-weight:800;text-decoration:none;box-shadow:0 10px 24px rgba(191,242,218,.35);line-height:1;white-space:nowrap}
    .apt-cta.ghost{background:transparent;color:var(--acc);border:1px solid var(--ring);box-shadow:none}

    /* ===== RIGHT: Chat + QR ===== */
    .chat-host{position:relative;overflow:hidden}
    .chat-host::before{
      content:""; position:absolute; inset:0; z-index:0; border-radius:16px;
      background: linear-gradient(rgba(0,0,0,var(--wall2_dim)), rgba(0,0,0,var(--wall2_dim))), var(--wall2, none);
      background-size:cover; background-position:center;
    }
    .chat-host > *{position:relative; z-index:1}

    .chat-window{
      display:flex;flex-direction:column;width:100%;max-width:420px;height:440px;color:#fff;border-radius:10px;
      overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.08);
      background: rgba(18,18,18,var(--chat_glass_alpha));
      backdrop-filter: blur(var(--chat_blur)); -webkit-backdrop-filter: blur(var(--chat_blur));
      margin-inline:auto
    }
    .chat-header{background:var(--acc);color:#000;padding:10px 12px;font-weight:800;display:flex;align-items:center;justify-content:space-between}
    .chat-close{background:transparent;border:0;color:#000;font-weight:900;font-size:18px;cursor:pointer}

    .chat-messages{
      position:relative;flex:1;overflow-y:auto;padding:12px 12px 14px;font-size:14px;display:flex;flex-direction:column;
      background: rgba(24,24,24,var(--chat_msg_alpha))
    }
    .msg{margin:7px 0;padding:8px 10px;border-radius:8px;max-width:92%}
    .user{background:rgba(255,255,255,.10);align-self:flex-end}
    .bot{background:rgba(0,0,0,.35);align-self:flex-start}
    .chat-input-area{display:flex;border-top:1px solid #444}
    .chat-input{flex:1;border:none;padding:11px 10px;font-size:14px;background: rgba(46,46,46,var(--input_alpha)); color:#fff}
    .chat-input:focus{outline:none}
    .chat-send{background:var(--acc);color:#000;border:none;padding:0 16px;cursor:pointer;font-weight:800}

    .chat-actions{display:flex;align-items:center;justify-content:center;gap:18px;margin:16px auto 0;max-width:420px}
    .apt-qr-wrap{position:relative;width:var(--qr_size);height:var(--qr_size)}
    .apt-qr{
      position:absolute;inset:0;border-radius:14px;
      background: transparent; border:1px solid rgba(255,255,255,.22);
      box-shadow:0 10px 24px rgba(0,0,0,.40); display:grid; place-items:center; overflow:hidden
    }
    .apt-qr::before{
      content:""; position:absolute; inset:2px; border-radius:12px;
      background: rgba(255,255,255,var(--qr_plate_alpha));
      backdrop-filter: blur(var(--qr_blur)); -webkit-backdrop-filter: blur(var(--qr_blur));
      z-index:0; box-shadow: inset 0 0 0 1px rgba(0,0,0,.06);
    }
    .apt-qr img{
      position:relative; z-index:1; width:100%; height:100%;
      object-fit: contain; image-rendering: pixelated; image-rendering: crisp-edges;
    }

    /* >>> Bubble: runde Form, heller & mit Blur/Glas */
    .chat-toggle{
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      width:var(--bubble_size); height:var(--bubble_size); border-radius:50%;
      background: rgba(191,242,218,.75);
      color:#0b1b15; font-size:18px; display:grid; place-items:center; cursor:pointer;
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      box-shadow:
        0 10px 22px rgba(191,242,218,.35),
        0 0 0 1px rgba(255,255,255,.55) inset;
      z-index:2
    }
    .chat-toggle::after{
      content:""; position:absolute; inset:0; border-radius:50%;
      background: radial-gradient(120% 120% at 30% 25%, rgba(255,255,255,.45) 0%, rgba(255,255,255,0) 60%);
      pointer-events:none;
    }
    .chat-badge{position:absolute;top:-6px;right:-6px;background:red;color:#fff;font-size:11px;padding:2px 6px;border-radius:50%;display:none}

    /* Popup Ã¼ber dem QR */
    .popup-wrap{position:absolute;left:calc(50% - 210px); bottom:210px; z-index:6; display:none}
    @media(max-width:520px){ .popup-wrap{left:8px; right:8px} }
    @media(max-width:600px){
      .apt-qr-wrap{width:132px;height:132px}
      .chat-window{height:420px}
    }

    /* >>> Link-Farbe in Chat-Nachrichten */
    .chat-messages a,
    .chat-messages a:visited { color: var(--acc); }
  </style>

  <div class="apt-grid">
    <!-- LEFT -->
    <div class="apt-card">
      <h2 class="apt-h1">
        <span class="prefix">Willkommen bei deinem</span>
        <span class="main">Accommodation-Concierge ğŸ›ï¸</span>
      </h2>
      <p class="apt-lead">Frag einfach los â€“ zu Check-in, Hausregeln, Ausstattung oder Tipps in der Umgebung. Der Accommodation Concierge hilft dir sofort weiter.</p>

      <div class="apt-badges">
        <span class="apt-pill">ğŸ•’ 24/7 GÃ¤steservice</span>
        <span class="apt-pill">ğŸ½ï¸ Insider-Tipps & AktivitÃ¤ten</span>
        <span class="apt-pill">ğŸ”’ Datenschutzfreundlich</span>
        <a class="apt-pill" href="mailto:contact@eudemonia-coaching.de?subject=White%20Label%20ready">ğŸ·ï¸ White Label ready</a>
        <a class="apt-pill" href="mailto:contact@eudemonia-coaching.de?subject=Franchise%20Programm">ğŸ¤ Franchise Programm</a>
        <a class="apt-pill" href="mailto:contact@eudemonia-coaching.de?subject=Affiliate-Link%20Datenbank%20%28Services%20%26%20Buchungen%29">ğŸ”— Affiliate-Link Datenbank</a>
      </div>

      <ul class="apt-ul">
        <li>WLAN, Parkplatz, GerÃ¤te-Guides, MÃ¼ll & Recycling</li>
        <li>Beste Restaurants, StrÃ¤nde, Touren & Transport</li>
        <li>Buchbare Extras: Early/Late Check-out, Beauty-Behandlung, Private Chef, Inhouse Massage, Shuttle <strong>(Es kann sich um Affiliate-Links handeln)</strong></li>
      </ul>

      <div class="apt-row">
        <div class="apt-row-inner">
          <a class="apt-cta"   href="mailto:contact@eudemonia-coaching.de?subject=GPT%20bestellen%20%28inkl.%20Landingpage%29">GPT-Bestellen (inkl. Landingpage)</a>
          <a class="apt-cta ghost" href="mailto:contact@eudemonia-coaching.de?subject=GPT%20bestellen%20%28ohne%20Landingpage%29">GPT-Bestellen (ohne Landingpage)</a>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="apt-card chat-host">
      <div class="chat-window" id="inline-chat">
        <div class="chat-header">
          <span>ğŸ’¬ Accommodation-Concierge</span>
          <button class="chat-close" id="inline-close" title="Minimieren" style="display:none">Ã—</button>
        </div>
        <div class="chat-messages" id="inline-messages"></div>
        <div class="chat-input-area">
          <input type="text" class="chat-input" id="inline-input" placeholder="Frag z. B.: 'Wo kann ich heute gut essen?'" />
          <button class="chat-send" id="inline-send">Senden</button>
        </div>
      </div>

      <!-- QR + Bubble -->
      <div class="chat-actions">
        <div class="apt-qr-wrap">
          <a class="apt-qr" id="apt-qr" href="#openChat" title="Scannen zum Ã–ffnen des Chats">
            <img id="apt-qr-img" alt="QR zum Ã–ffnen des Chats" />
          </a>
          <div class="chat-toggle" id="bubble-btn" aria-label="Chat Ã¶ffnen">ğŸ’¬
            <span class="chat-badge" id="bubble-badge">1</span>
          </div>
        </div>
      </div>

      <!-- Popup -->
      <div class="popup-wrap" id="popup-wrap">
        <div class="chat-window" id="popup-chat">
          <div class="chat-header">
            <span>ğŸ’¬ Accommodation-Concierge</span>
            <button class="chat-close" id="popup-close" title="SchlieÃŸen">Ã—</button>
          </div>
          <div class="chat-messages" id="popup-messages"></div>
          <div class="chat-input-area">
            <input type="text" class="chat-input" id="popup-input" placeholder="Frag z. B.: 'Wie lÃ¤uft der Check-in?'" />
            <button class="chat-send" id="popup-send">Senden</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const webhookUrl = "https://automation.eudemonia-coaching.de/webhook/chat-webhook";
      const APT_NAME = "Ihr Apartment";
      const QR_IMG  = document.getElementById('apt-qr-img');
      const QR_LINK = document.getElementById('apt-qr');

      const inline = { messages: document.getElementById('inline-messages'), input: document.getElementById('inline-input'), send: document.getElementById('inline-send') };
      const popup  = { wrap: document.getElementById('popup-wrap'), messages: document.getElementById('popup-messages'), input: document.getElementById('popup-input'), send: document.getElementById('popup-send'), openBtn: document.getElementById('bubble-btn'), badge: document.getElementById('bubble-badge'), closeBtn: document.getElementById('popup-close') };

      let unread = 0;
      function openPopup(){
        popup.wrap.style.display='block';
        unread=0; popup.badge.style.display='none';
        setTimeout(()=>{ popup.input?.focus(); document.querySelector('.chat-host')?.scrollIntoView({behavior:'smooth', block:'center'}); }, 50);
      }
      function closePopup(){ popup.wrap.style.display='none'; }
      popup.openBtn.addEventListener('click', openPopup);
      popup.closeBtn.addEventListener('click', closePopup);

      // Beim Klick auf den QR IN der Seite: Popup direkt Ã¶ffnen (kein Seitenwechsel)
      QR_LINK.addEventListener('click', function(e){ e.preventDefault(); openPopup(); });

      function tryOpenFromUrl(){
        const s = new URLSearchParams(location.search);
        if (location.hash === '#openChat' || s.get('openChat') === '1'){ openPopup(); }
      }
      window.addEventListener('hashchange', tryOpenFromUrl);

      // QR (mit Fallback)
      (function setQr(){
        var base   = location.href.split('#')[0];
        var url    = new URL(base);
        url.searchParams.set('openChat','1');
        var target = url.toString() + '#openChat';

        var qrMargin = 8;
        var src1 = 'https://quickchart.io/qr?text=' + encodeURIComponent(target) +
                   '&size=512&margin=' + qrMargin + '&ecLevel=H&format=png' +
                   '&dark=%23000000' + '&light=%23ffffff00';
        var src2 = 'https://chart.googleapis.com/chart?cht=qr&chs=512x512&chld=H|1&chl=' + encodeURIComponent(target);

        var img = QR_IMG;
        img.onerror = function(){ if (img.dataset.fallback !== '1'){ img.dataset.fallback='1'; img.src = src2; } };
        img.src = src1;
      })();

      function el(tag, cls, text){ const e=document.createElement(tag); if(cls)e.className=cls; if(text!=null)e.innerText=text; return e; }

      // ===== Linkify + Pretty Label =====
      function prettyLabel(href, max=48) {
        try {
          const u = new URL(href);
          const host = u.hostname.replace(/^www\./,'');
          let path = u.pathname || '';
          path = path.replace(/\/$/, '');
          if (path.length > 24) path = path.slice(0, 24) + 'â€¦';
          const label = host + (path ? ('/' + path) : '');
          return label.length > max ? label.slice(0, max) + 'â€¦' : label;
        } catch {
          return href.length > max ? href.slice(0, max) + 'â€¦' : href;
        }
      }

      function linkifyInto(container) {
        const URL_RE = /((https?:\/\/|www\.)[^\s<>"'`]+)(?![^<]*>|[^&]*;)/gi;
        function walk(node){
          if (node.nodeType === 3) {
            const text = node.nodeValue;
            if(!text) return;
            const frag = document.createDocumentFragment();
            let last = 0, m;
            URL_RE.lastIndex = 0;
            while ((m = URL_RE.exec(text)) !== null) {
              const raw = m[0];
              const href = raw.startsWith('www.') ? 'https://' + raw : raw;
              const endClean = raw.replace(/[),.;!?]+$/,'');
              if (m.index > last) frag.appendChild(document.createTextNode(text.slice(last, m.index)));
              const a = document.createElement('a');
              a.href = href;
              a.target = '_blank';
              a.rel = 'noopener noreferrer nofollow';
              a.textContent = prettyLabel(href);
              frag.appendChild(a);
              last = m.index + raw.length;
              const trailing = raw.slice(endClean.length);
              if (trailing) frag.appendChild(document.createTextNode(trailing));
            }
            if (last === 0) return;
            if (last < text.length) frag.appendChild(document.createTextNode(text.slice(last)));
            node.parentNode.replaceChild(frag, node);
          } else if (node.nodeType === 1 && node.childNodes) {
            Array.from(node.childNodes).forEach(walk);
          }
        }
        walk(container);
      }

      function appendMsg(target, text, sender){
        const m = el('div','msg '+sender);
        m.textContent = text;           // sicher gegen HTML
        linkifyInto(m);                 // URLs klickbar machen (Pretty Label)
        target.appendChild(m);
        target.scrollTop = target.scrollHeight;
      }

      function addMessageAll(text, sender, save=true){
        appendMsg(inline.messages, text, sender);
        appendMsg(popup.messages,  text, sender);
        if(save){
          const history = JSON.parse(localStorage.getItem('aptChatHistory') || '[]');
          history.push({ text, sender });
          localStorage.setItem('aptChatHistory', JSON.stringify(history));
        }
        if(sender==='bot' && popup.wrap.style.display==='none'){
          unread++; popup.badge.innerText = unread; popup.badge.style.display = 'block';
        }
      }
      function typingOn(){ appendMsg(inline.messages,'Tipptâ€¦','bot'); inline.messages.lastChild.id='inline-typing'; appendMsg(popup.messages,'Tipptâ€¦','bot'); popup.messages.lastChild.id='popup-typing'; }
      function typingOff(){ const a=document.getElementById('inline-typing'); if(a) a.remove(); const b=document.getElementById('popup-typing'); if(b) b.remove(); }

      function loadHistory(){
        const history = JSON.parse(localStorage.getItem('aptChatHistory') || '[]');
        history.forEach(m=>addMessageAll(m.text,m.sender,false));
        if(history.length===0){
          addMessageAll(
`Willkommen! ğŸ‘‹
Ich helfe dir bei Check-in, Hausregeln, Ausstattung und den besten Tipps in der Umgebung. Frag einfach los.`,
            'bot', true
          );
        }
      }

      // Antwort robust als Text lesen (JSON oder text/plain)
      async function readAnswerAsText(res) {
        var ct = (res.headers.get('content-type') || '').toLowerCase();
        if (ct.indexOf('application/json') !== -1) {
          try {
            var data = await res.json();
            if (data == null) return '';
            if (typeof data === 'string') return data;
            var candidates = [];
            if (data.answer) candidates.push(data.answer);
            if (data.output) candidates.push(data.output);
            if (data.text) candidates.push(data.text);
            if (data.message) candidates.push(data.message);
            if (data.content) candidates.push(data.content);
            if (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
              candidates.push(data.choices[0].message.content);
            }
            return candidates.length ? String(candidates[0]) : '';
          } catch(e){ return ''; }
        }
        try { return await res.text(); } catch(e){ return ''; }
      }

      // Senden
      async function sendMessage(from){
        const ctx  = (from==='popup') ? {input:popup.input} : {input:inline.input};
        const text = (ctx.input.value || '').trim(); if(!text) return;
        addMessageAll(text,'user'); ctx.input.value=''; typingOn();

        try{
          const res = await fetch(webhookUrl, {
            method:'POST',
            headers:{
              'Content-Type':'application/json',
              'Accept':'application/json, text/plain; q=0.9, */*; q=0.8'
            },
            body: JSON.stringify({ question:text, url:window.location.href, meta:{ apartment:APT_NAME, source:from } })
          });

          const answer = await readAnswerAsText(res);
          typingOff();
          addMessageAll( (answer && String(answer).trim()) ? String(answer).trim() : 'Keine Antwort erhalten.', 'bot' );
        }catch(e){
          typingOff();
          addMessageAll('Fehler beim Senden.','bot');
        }
      }

      document.getElementById('inline-send').addEventListener('click', ()=>sendMessage('inline'));
      document.getElementById('popup-send').addEventListener('click',  ()=>sendMessage('popup'));
      document.getElementById('inline-input').addEventListener('keypress', e=>{ if(e.key==='Enter') sendMessage('inline'); });
      document.getElementById('popup-input').addEventListener('keypress',  e=>{ if(e.key==='Enter') sendMessage('popup'); });

      loadHistory(); tryOpenFromUrl();
    })();
  </script>
</div>
<!-- ===== Ende ===== -->
